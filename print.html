<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title></title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="INTRODUCTION.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="SmartContracts.html"><strong aria-hidden="true">2.</strong> Smart Contracts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="CAPE.html"><strong aria-hidden="true">2.1.</strong> CAPE</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="AssetRegistry.html"><strong aria-hidden="true">2.1.1.</strong> AssetRegistry</a></li><li class="chapter-item expanded "><a href="RecordsMerkleTree.html"><strong aria-hidden="true">2.1.2.</strong> RecordsMerkleTree</a></li><li class="chapter-item expanded "><a href="RootStore.html"><strong aria-hidden="true">2.1.3.</strong> RootStore</a></li><li class="chapter-item expanded "><a href="interfaces/IPlonkVerifier.html"><strong aria-hidden="true">2.1.4.</strong> IPlonkVerifier</a></li><li class="chapter-item expanded "><a href="verifier/PlonkVerifier.html"><strong aria-hidden="true">2.1.5.</strong> PlonkVerifier</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="Security.html"><strong aria-hidden="true">3.</strong> Security</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="MaliciousERC20TokenContract.html"><strong aria-hidden="true">3.1.</strong> DoS on Relayer via malicious ERC20 token contract</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!--
 ~ Copyright (c) 2022 Espresso Systems (espressosys.com)
 ~ This file is part of the Configurable Asset Privacy for Ethereum (CAPE) library.
 ~
 ~ This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
 ~ This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 ~ You should have received a copy of the GNU General Public License along with this program. If not, see <https://www.gnu.org/licenses/>.
 -->
<h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>The CAPE system is a set of components which purpose is to enable users to</p>
<ul>
<li>Create, Transfer and Freeze assets.</li>
<li>Wrap ERC20 tokens into CAPE asset records.</li>
<li>Unwrap CAPE asset records back into ERC20 tokens.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><!--
 ~ Copyright (c) 2022 Espresso Systems (espressosys.com)
 ~ This file is part of the Configurable Asset Privacy for Ethereum (CAPE) library.
 ~
 ~ This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
 ~ This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 ~ You should have received a copy of the GNU General Public License along with this program. If not, see <https://www.gnu.org/licenses/>.
 -->
<h1 id="smart-contracts"><a class="header" href="#smart-contracts">Smart contracts</a></h1>
<h2 id="cape-contract"><a class="header" href="#cape-contract">CAPE Contract</a></h2>
<p>The CAPE Smart contract allows bidirectional transfers of assets between Ethereum and the CAPE system. 
Its design is inspired by <a href="https://tornado.cash/">Tornado Cash</a> where an ERC20 token transfer can trigger automatically the creation of some asset record inside the CAPE Blockchain. 
Transferring assets from CAPE to Ethereum relies on the idea of burning/destroying the asset record and unlock it on the other side (Ethereum) also in an atomic fashion.</p>
<h3 id="interfaces"><a class="header" href="#interfaces">Interfaces</a></h3>
<p>The CAPE contract has 4 public <a href="./CAPE.html">interfaces</a>: </p>
<ul>
<li><code>constructor</code> that is run only once when the contract is deployed.</li>
<li><code>sponsorCapeAsset</code> which allows to register a new asset type bound to an ERC20 token. </li>
<li><code>depositErc20</code> allows to <em>wrap</em> ERC20 tokens into some asset records of a specific type that has already been registered earlier through <code>sponsorCapeAsset</code>.</li>
<li><code>submitCapeBlock</code> allows anyone to submit a block of CAPE transactions. If all the transactions in this block are valid then the state of the CAPE blockchain will be updated accordingly. If a transaction in the block is of type BURN, the asset records will be destroyed and the equivalent amount of ERC20 token will be sent to some specified ethereum address. This process is called <em>unwrapping</em>. </li>
</ul>
<h3 id="sequence-diagram"><a class="header" href="#sequence-diagram">Sequence Diagram</a></h3>
<p><img src="./smart_contract_sequence_diagram.png" alt="image" /></p>
<p>In the sequence diagram above we describe how the CAPE contract can be used to wrap/unwrap ERC20 tokens and make transfers within the CAPE blockchain.</p>
<ul>
<li><strong>Sponsor asset type:</strong>
Before being able to wrap an ERC20 token into a CAPE asset record, it is necessary to create an asset type which will bind an ERC20 to an identifier and a CAPE policy. 
This new asset type is created by some sponsor participant (user A in the diagram). 
Once created it is provided to the CAPE contract which will store it along with the address of the corresponding ERC20 token.</li>
<li><strong>Wrapping: USDC → CAPE asset record:</strong>
User A wraps his USDC tokens into some CAPE records using some asset type created in the previous phase.</li>
<li><strong>Transfers within CAPE:</strong>
User A sends (part of) his assets to User B inside the CAPE blockchain.</li>
<li><strong>CAPE asset record → USDC:</strong>
User B manages to unwrap his asset record received from User A by creating a special <em>BURN</em> transaction that will destroy this asset record but credit his (ethereum) address 
with some USDC tokens. 
These tokens are directly sent to the user as soon as the <em>BURN</em> transaction is processed.</li>
</ul>
<h2 id="erc20-contracts"><a class="header" href="#erc20-contracts">ERC20 contracts</a></h2>
<p>The CAPE contract can interact with any ERC20 token available on Ethereum. 
In other words a token that implements the <a href="https://eips.ethereum.org/EIPS/eip-20">ERC20 interface</a> can be wrapped into some CAPE asset record.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="functions"><a class="header" href="#functions">Functions</a></h1>
<h2 id="constructor"><a class="header" href="#constructor">constructor</a></h2>
<pre><code class="language-solidity">  function constructor(
    uint64 nRoots,
    address verifierAddr
  ) public
</code></pre>
<p>CAPE contract constructor method.</p>
<h3 id="parameters"><a class="header" href="#parameters">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>nRoots</code></td><td style="text-align: left">uint64</td><td style="text-align: left">number of the most recent roots of the records merkle tree to be stored</td></tr>
<tr><td style="text-align: left"><code>verifierAddr</code></td><td style="text-align: left">address</td><td style="text-align: left">address of the Plonk Verifier contract</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="faucetsetupfortestnet"><a class="header" href="#faucetsetupfortestnet">faucetSetupForTestnet</a></h2>
<pre><code class="language-solidity">  function faucetSetupForTestnet(
    struct EdOnBN254.EdOnBN254Point faucetManagerAddress,
    bytes32 faucetManagerEncKey
  ) external
</code></pre>
<p>Allocate native token faucet to a manager. For testnet only.</p>
<h3 id="parameters-1"><a class="header" href="#parameters-1">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>faucetManagerAddress</code></td><td style="text-align: left">struct EdOnBN254.EdOnBN254Point</td><td style="text-align: left">address of public key of faucet manager for CAP native token (testnet only!)</td></tr>
<tr><td style="text-align: left"><code>faucetManagerEncKey</code></td><td style="text-align: left">bytes32</td><td style="text-align: left">public key of faucet manager for CAP native token (testnet only!)</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_publish"><a class="header" href="#_publish">_publish</a></h2>
<pre><code class="language-solidity">  function _publish(
    uint256[] newNullifiers
  ) internal
</code></pre>
<p>Publish an array of nullifiers.</p>
<p>Requires all nullifiers to be unique and unpublished.
A block creator must not submit notes with duplicate nullifiers.</p>
<h3 id="parameters-2"><a class="header" href="#parameters-2">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>newNullifiers</code></td><td style="text-align: left">uint256[]</td><td style="text-align: left">list of nullifiers to publish</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_publish-1"><a class="header" href="#_publish-1">_publish</a></h2>
<pre><code class="language-solidity">  function _publish(
    uint256 nullifier
  ) internal
</code></pre>
<p>Publish a nullifier if it hasn't been published before.</p>
<p>Reverts if the nullifier is already published.</p>
<h3 id="parameters-3"><a class="header" href="#parameters-3">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>nullifier</code></td><td style="text-align: left">uint256</td><td style="text-align: left">nullifier to publish</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="depositerc20"><a class="header" href="#depositerc20">depositErc20</a></h2>
<pre><code class="language-solidity">  function depositErc20(
    struct CAPE.RecordOpening ro,
    address erc20Address
  ) external
</code></pre>
<p>Wraps ERC-20 tokens into a CAPE asset defined in the record opening.</p>
<h3 id="parameters-4"><a class="header" href="#parameters-4">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>ro</code></td><td style="text-align: left">struct CAPE.RecordOpening</td><td style="text-align: left">record opening that will be inserted in the records merkle tree once the deposit is validated</td></tr>
<tr><td style="text-align: left"><code>erc20Address</code></td><td style="text-align: left">address</td><td style="text-align: left">address of the ERC-20 token corresponding to the deposit</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="submitcapeblockwithmemos"><a class="header" href="#submitcapeblockwithmemos">submitCapeBlockWithMemos</a></h2>
<pre><code class="language-solidity">  function submitCapeBlockWithMemos(
    struct CAPE.CapeBlock newBlock,
    bytes extraData
  ) external
</code></pre>
<p>Submit a new block with extra data to the CAPE contract.</p>
<h3 id="parameters-5"><a class="header" href="#parameters-5">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>newBlock</code></td><td style="text-align: left">struct CAPE.CapeBlock</td><td style="text-align: left">block to be processed by the CAPE contract</td></tr>
<tr><td style="text-align: left"><code>extraData</code></td><td style="text-align: left">bytes</td><td style="text-align: left">data to be stored in calldata; this data is ignored by the contract function</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="submitcapeblock"><a class="header" href="#submitcapeblock">submitCapeBlock</a></h2>
<pre><code class="language-solidity">  function submitCapeBlock(
    struct CAPE.CapeBlock newBlock
  ) public
</code></pre>
<p>Submit a new block to the CAPE contract.</p>
<p>Transactions are validated and the blockchain state is updated. Moreover <em>BURN</em> transactions trigger the unwrapping of cape asset records into erc20 tokens.</p>
<h3 id="parameters-6"><a class="header" href="#parameters-6">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>newBlock</code></td><td style="text-align: left">struct CAPE.CapeBlock</td><td style="text-align: left">block to be processed by the CAPE contract.</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_emitblockevent"><a class="header" href="#_emitblockevent">_emitBlockEvent</a></h2>
<pre><code class="language-solidity">  function _emitBlockEvent(
  ) internal
</code></pre>
<p>This function only exists to avoid a stack too deep compilation error.</p>
<hr />
<h2 id="_handlewithdrawal"><a class="header" href="#_handlewithdrawal">_handleWithdrawal</a></h2>
<pre><code class="language-solidity">  function _handleWithdrawal(
    struct CAPE.BurnNote note
  ) internal
</code></pre>
<p>send the ERC-20 tokens equivalent to the asset records being burnt. Recall that the burned record opening is contained inside the note.</p>
<h3 id="parameters-7"><a class="header" href="#parameters-7">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>note</code></td><td style="text-align: left">struct CAPE.BurnNote</td><td style="text-align: left">note of type <em>BURN</em></td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_computenumcommitments"><a class="header" href="#_computenumcommitments">_computeNumCommitments</a></h2>
<pre><code class="language-solidity">  function _computeNumCommitments(
  ) internal returns (uint256)
</code></pre>
<p>Compute an upper bound on the number of records to be inserted</p>
<hr />
<h2 id="_checktransfer"><a class="header" href="#_checktransfer">_checkTransfer</a></h2>
<pre><code class="language-solidity">  function _checkTransfer(
    struct CAPE.TransferNote note
  ) internal
</code></pre>
<p>Verify if a note is of type <em>TRANSFER</em>.</p>
<h3 id="parameters-8"><a class="header" href="#parameters-8">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>note</code></td><td style="text-align: left">struct CAPE.TransferNote</td><td style="text-align: left">note which could be of type <em>TRANSFER</em> or <em>BURN</em></td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_isexpired"><a class="header" href="#_isexpired">_isExpired</a></h2>
<pre><code class="language-solidity">  function _isExpired(
    struct CAPE.TransferNote note
  ) internal returns (bool)
</code></pre>
<p>Check if a note has expired.</p>
<h3 id="parameters-9"><a class="header" href="#parameters-9">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>note</code></td><td style="text-align: left">struct CAPE.TransferNote</td><td style="text-align: left">note for which we want to check its timestamp against the current block height</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_checkburn"><a class="header" href="#_checkburn">_checkBurn</a></h2>
<pre><code class="language-solidity">  function _checkBurn(
    struct CAPE.BurnNote note
  ) internal
</code></pre>
<p>Check if a burn note is well formed.</p>
<h3 id="parameters-10"><a class="header" href="#parameters-10">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>note</code></td><td style="text-align: left">struct CAPE.BurnNote</td><td style="text-align: left">note of type <em>BURN</em></td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_containsburnprefix"><a class="header" href="#_containsburnprefix">_containsBurnPrefix</a></h2>
<pre><code class="language-solidity">  function _containsBurnPrefix(
    bytes byteSeq
  ) internal returns (bool)
</code></pre>
<p>Checks if a sequence of bytes contains hardcoded prefix.</p>
<h3 id="parameters-11"><a class="header" href="#parameters-11">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>byteSeq</code></td><td style="text-align: left">bytes</td><td style="text-align: left">sequence of bytes</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_containsburnrecord"><a class="header" href="#_containsburnrecord">_containsBurnRecord</a></h2>
<pre><code class="language-solidity">  function _containsBurnRecord(
    struct CAPE.BurnNote note
  ) internal returns (bool)
</code></pre>
<p>Check if the burned record opening and the record commitment in position 1 are consistent.</p>
<h3 id="parameters-12"><a class="header" href="#parameters-12">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>note</code></td><td style="text-align: left">struct CAPE.BurnNote</td><td style="text-align: left">note of type <em>BURN</em></td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_deriverecordcommitment"><a class="header" href="#_deriverecordcommitment">_deriveRecordCommitment</a></h2>
<pre><code class="language-solidity">  function _deriveRecordCommitment(
    struct CAPE.RecordOpening ro
  ) internal returns (uint256 rc)
</code></pre>
<p>Compute the commitment of a record opening.</p>
<h3 id="parameters-13"><a class="header" href="#parameters-13">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>ro</code></td><td style="text-align: left">struct CAPE.RecordOpening</td><td style="text-align: left">record opening</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_prepareforproofverification"><a class="header" href="#_prepareforproofverification">_prepareForProofVerification</a></h2>
<pre><code class="language-solidity">  function _prepareForProofVerification(
    struct CAPE.TransferNote note
  ) internal returns (struct IPlonkVerifier.VerifyingKey vk, uint256[] publicInput, struct IPlonkVerifier.PlonkProof proof, bytes transcriptInitMsg)
</code></pre>
<p>An overloaded function (one for each note type) to prepare all inputs necessary for batch verification of the plonk proof.</p>
<h3 id="parameters-14"><a class="header" href="#parameters-14">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>note</code></td><td style="text-align: left">struct CAPE.TransferNote</td><td style="text-align: left">note of type <em>TRANSFER</em></td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_prepareforproofverification-1"><a class="header" href="#_prepareforproofverification-1">_prepareForProofVerification</a></h2>
<pre><code class="language-solidity">  function _prepareForProofVerification(
    struct CAPE.BurnNote note
  ) internal returns (struct IPlonkVerifier.VerifyingKey, uint256[], struct IPlonkVerifier.PlonkProof, bytes)
</code></pre>
<p>An overloaded function (one for each note type) to prepare all inputs necessary for batch verification of the plonk proof.</p>
<h3 id="parameters-15"><a class="header" href="#parameters-15">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>note</code></td><td style="text-align: left">struct CAPE.BurnNote</td><td style="text-align: left">note of type <em>BURN</em></td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_prepareforproofverification-2"><a class="header" href="#_prepareforproofverification-2">_prepareForProofVerification</a></h2>
<pre><code class="language-solidity">  function _prepareForProofVerification(
    struct CAPE.MintNote note
  ) internal returns (struct IPlonkVerifier.VerifyingKey vk, uint256[] publicInput, struct IPlonkVerifier.PlonkProof proof, bytes transcriptInitMsg)
</code></pre>
<p>An overloaded function (one for each note type) to prepare all inputs necessary for batch verification of the plonk proof.</p>
<h3 id="parameters-16"><a class="header" href="#parameters-16">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>note</code></td><td style="text-align: left">struct CAPE.MintNote</td><td style="text-align: left">note of type <em>MINT</em></td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_prepareforproofverification-3"><a class="header" href="#_prepareforproofverification-3">_prepareForProofVerification</a></h2>
<pre><code class="language-solidity">  function _prepareForProofVerification(
    struct CAPE.FreezeNote note
  ) internal returns (struct IPlonkVerifier.VerifyingKey vk, uint256[] publicInput, struct IPlonkVerifier.PlonkProof proof, bytes transcriptInitMsg)
</code></pre>
<p>An overloaded function (one for each note type) to prepare all inputs necessary for batch verification of the plonk proof.</p>
<h3 id="parameters-17"><a class="header" href="#parameters-17">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>note</code></td><td style="text-align: left">struct CAPE.FreezeNote</td><td style="text-align: left">note of type <em>FREEZE</em></td></tr>
</tbody></table>
</div>
<hr />
<h2 id="getrootvalue"><a class="header" href="#getrootvalue">getRootValue</a></h2>
<pre><code class="language-solidity">  function getRootValue(
  ) external returns (uint256)
</code></pre>
<hr />
<h1 id="events"><a class="header" href="#events">Events</a></h1>
<h2 id="faucetinitialized"><a class="header" href="#faucetinitialized">FaucetInitialized</a></h2>
<pre><code class="language-solidity">  event FaucetInitialized(
  )
</code></pre>
<hr />
<h2 id="blockcommitted"><a class="header" href="#blockcommitted">BlockCommitted</a></h2>
<pre><code class="language-solidity">  event BlockCommitted(
  )
</code></pre>
<hr />
<h2 id="erc20tokensdeposited"><a class="header" href="#erc20tokensdeposited">Erc20TokensDeposited</a></h2>
<pre><code class="language-solidity">  event Erc20TokensDeposited(
  )
</code></pre>
<hr />
<div style="break-before: page; page-break-before: always;"></div><h1 id="functions-1"><a class="header" href="#functions-1">Functions</a></h1>
<h2 id="nativedomesticasset"><a class="header" href="#nativedomesticasset">nativeDomesticAsset</a></h2>
<pre><code class="language-solidity">  function nativeDomesticAsset(
  ) public returns (struct AssetRegistry.AssetDefinition assetDefinition)
</code></pre>
<p>Return the CAP-native asset definition.</p>
<hr />
<h2 id="lookup"><a class="header" href="#lookup">lookup</a></h2>
<pre><code class="language-solidity">  function lookup(
    struct AssetRegistry.AssetDefinition assetDefinition
  ) public returns (address)
</code></pre>
<p>Fetch the ERC-20 token address corresponding to the
given asset definition.</p>
<h3 id="parameters-18"><a class="header" href="#parameters-18">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>assetDefinition</code></td><td style="text-align: left">struct AssetRegistry.AssetDefinition</td><td style="text-align: left">an asset definition</td></tr>
</tbody></table>
</div>
<h3 id="return-values"><a class="header" href="#return-values">Return Values</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Returns</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left">⇒</td><td style="text-align: left">struct AssetRegistry.AssetDefinition</td><td style="text-align: left">ERC-20 address</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="iscapeassetregistered"><a class="header" href="#iscapeassetregistered">isCapeAssetRegistered</a></h2>
<pre><code class="language-solidity">  function isCapeAssetRegistered(
    struct AssetRegistry.AssetDefinition assetDefinition
  ) public returns (bool)
</code></pre>
<p>Is the given asset definition registered?</p>
<h3 id="parameters-19"><a class="header" href="#parameters-19">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>assetDefinition</code></td><td style="text-align: left">struct AssetRegistry.AssetDefinition</td><td style="text-align: left">an asset definition</td></tr>
</tbody></table>
</div>
<h3 id="return-values-1"><a class="header" href="#return-values-1">Return Values</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Returns</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left">⇒</td><td style="text-align: left">struct AssetRegistry.AssetDefinition</td><td style="text-align: left">if the asset type is registered, false otherwise.</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="sponsorcapeasset"><a class="header" href="#sponsorcapeasset">sponsorCapeAsset</a></h2>
<pre><code class="language-solidity">  function sponsorCapeAsset(
    address erc20Address,
    struct AssetRegistry.AssetDefinition newAsset
  ) external
</code></pre>
<p>Create and register a new asset type associated with an
ERC-20 token. Will revert if the asset type is already
registered or the ERC-20 token address is zero.</p>
<h3 id="parameters-20"><a class="header" href="#parameters-20">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>erc20Address</code></td><td style="text-align: left">address</td><td style="text-align: left">An ERC-20 token address</td></tr>
<tr><td style="text-align: left"><code>newAsset</code></td><td style="text-align: left">struct AssetRegistry.AssetDefinition</td><td style="text-align: left">An asset type to be registered in the contract</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_checkforeignassetcode"><a class="header" href="#_checkforeignassetcode">_checkForeignAssetCode</a></h2>
<pre><code class="language-solidity">  function _checkForeignAssetCode(
    uint256 assetDefinitionCode,
    address erc20Address,
    address sponsor,
    struct AssetRegistry.AssetPolicy policy
  ) internal
</code></pre>
<p>Throws an exception if the asset definition code is
not correctly derived from the ERC-20 address of the token and
the address of the sponsor.</p>
<p>Requires &quot;view&quot; to access msg.sender.</p>
<h3 id="parameters-21"><a class="header" href="#parameters-21">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>assetDefinitionCode</code></td><td style="text-align: left">uint256</td><td style="text-align: left">The code of an asset definition</td></tr>
<tr><td style="text-align: left"><code>erc20Address</code></td><td style="text-align: left">address</td><td style="text-align: left">The ERC-20 address bound to the asset definition</td></tr>
<tr><td style="text-align: left"><code>sponsor</code></td><td style="text-align: left">address</td><td style="text-align: left">The sponsor address of this wrapped asset</td></tr>
<tr><td style="text-align: left"><code>policy</code></td><td style="text-align: left">struct AssetRegistry.AssetPolicy</td><td style="text-align: left">asset policy</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_checkdomesticassetcode"><a class="header" href="#_checkdomesticassetcode">_checkDomesticAssetCode</a></h2>
<pre><code class="language-solidity">  function _checkDomesticAssetCode(
    uint256 assetDefinitionCode,
    uint256 internalAssetCode
  ) internal
</code></pre>
<p>Checks if the asset definition code is correctly derived from the internal asset code.</p>
<h3 id="parameters-22"><a class="header" href="#parameters-22">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>assetDefinitionCode</code></td><td style="text-align: left">uint256</td><td style="text-align: left">asset definition code</td></tr>
<tr><td style="text-align: left"><code>internalAssetCode</code></td><td style="text-align: left">uint256</td><td style="text-align: left">internal asset code</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_computeassetdescription"><a class="header" href="#_computeassetdescription">_computeAssetDescription</a></h2>
<pre><code class="language-solidity">  function _computeAssetDescription(
    address erc20Address,
    address sponsor,
    struct AssetRegistry.AssetPolicy policy
  ) internal returns (bytes)
</code></pre>
<p>Compute the asset description from the address of the
ERC-20 token and the address of the sponsor.</p>
<h3 id="parameters-23"><a class="header" href="#parameters-23">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>erc20Address</code></td><td style="text-align: left">address</td><td style="text-align: left">address of the erc20 token</td></tr>
<tr><td style="text-align: left"><code>sponsor</code></td><td style="text-align: left">address</td><td style="text-align: left">address of the sponsor</td></tr>
<tr><td style="text-align: left"><code>policy</code></td><td style="text-align: left">struct AssetRegistry.AssetPolicy</td><td style="text-align: left">asset policy</td></tr>
</tbody></table>
</div>
<h3 id="return-values-2"><a class="header" href="#return-values-2">Return Values</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Returns</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left">⇒</td><td style="text-align: left">address</td><td style="text-align: left">asset description</td></tr>
</tbody></table>
</div>
<hr />
<h1 id="events-1"><a class="header" href="#events-1">Events</a></h1>
<h2 id="assetsponsored"><a class="header" href="#assetsponsored">AssetSponsored</a></h2>
<pre><code class="language-solidity">  event AssetSponsored(
  )
</code></pre>
<hr />
<div style="break-before: page; page-break-before: always;"></div><h1 id="functions-2"><a class="header" href="#functions-2">Functions</a></h1>
<h2 id="constructor-1"><a class="header" href="#constructor-1">constructor</a></h2>
<pre><code class="language-solidity">  function constructor(
    uint8 merkleTreeHeight
  ) public
</code></pre>
<p>Create a records Merkle tree of the given height.</p>
<h3 id="parameters-24"><a class="header" href="#parameters-24">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>merkleTreeHeight</code></td><td style="text-align: left">uint8</td><td style="text-align: left">The height</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_buildtreefromfrontier"><a class="header" href="#_buildtreefromfrontier">_buildTreeFromFrontier</a></h2>
<pre><code class="language-solidity">  function _buildTreeFromFrontier(
    struct RecordsMerkleTree.Node[] nodes
  ) internal returns (uint64)
</code></pre>
<p>Create a Merkle tree from the given frontier.</p>
<h3 id="parameters-25"><a class="header" href="#parameters-25">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>nodes</code></td><td style="text-align: left">struct RecordsMerkleTree.Node[]</td><td style="text-align: left">The list of nodes to be filled or updated</td></tr>
</tbody></table>
</div>
<h3 id="return-values-3"><a class="header" href="#return-values-3">Return Values</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Returns</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left">⇒</td><td style="text-align: left">struct RecordsMerkleTree.Node[]</td><td style="text-align: left">cursor to the root node of the create tree</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="updaterecordsmerkletree"><a class="header" href="#updaterecordsmerkletree">updateRecordsMerkleTree</a></h2>
<pre><code class="language-solidity">  function updateRecordsMerkleTree(
    uint256[] elements
  ) external
</code></pre>
<p>Update the state of the record merkle tree by inserting new elements.</p>
<h3 id="parameters-26"><a class="header" href="#parameters-26">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>elements</code></td><td style="text-align: left">uint256[]</td><td style="text-align: left">The list of elements to be appended to the current merkle tree described by the frontier.</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="getrootvalue-1"><a class="header" href="#getrootvalue-1">getRootValue</a></h2>
<pre><code class="language-solidity">  function getRootValue(
  ) external returns (uint256)
</code></pre>
<p>Returns the root value of the Merkle tree.</p>
<hr />
<h2 id="getheight"><a class="header" href="#getheight">getHeight</a></h2>
<pre><code class="language-solidity">  function getHeight(
  ) external returns (uint8)
</code></pre>
<p>Returns the height of the Merkle tree.</p>
<hr />
<h2 id="getnumleaves"><a class="header" href="#getnumleaves">getNumLeaves</a></h2>
<pre><code class="language-solidity">  function getNumLeaves(
  ) external returns (uint64)
</code></pre>
<p>Returns the number of leaves of the Merkle tree.</p>
<hr />
<div style="break-before: page; page-break-before: always;"></div><h1 id="functions-3"><a class="header" href="#functions-3">Functions</a></h1>
<h2 id="constructor-2"><a class="header" href="#constructor-2">constructor</a></h2>
<pre><code class="language-solidity">  function constructor(
    uint64 nRoots
  ) public
</code></pre>
<p>Create a root store.</p>
<h3 id="parameters-27"><a class="header" href="#parameters-27">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>nRoots</code></td><td style="text-align: left">uint64</td><td style="text-align: left">The maximum number of roots to store</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_addroot"><a class="header" href="#_addroot">_addRoot</a></h2>
<pre><code class="language-solidity">  function _addRoot(
    uint256 newRoot
  ) internal
</code></pre>
<p>Add a root value. Only keep the latest nRoots ones.</p>
<h3 id="parameters-28"><a class="header" href="#parameters-28">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>newRoot</code></td><td style="text-align: left">uint256</td><td style="text-align: left">The value of the new root</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_containsroot"><a class="header" href="#_containsroot">_containsRoot</a></h2>
<pre><code class="language-solidity">  function _containsRoot(
    uint256 root
  ) internal returns (bool)
</code></pre>
<p>Is the root value contained in the store?</p>
<h3 id="parameters-29"><a class="header" href="#parameters-29">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>root</code></td><td style="text-align: left">uint256</td><td style="text-align: left">The root value to find</td></tr>
</tbody></table>
</div>
<h3 id="return-values-4"><a class="header" href="#return-values-4">Return Values</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Returns</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left">⇒</td><td style="text-align: left">uint256</td><td style="text-align: left">True if the root value is in the store, false otherwise</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_checkcontainsroot"><a class="header" href="#_checkcontainsroot">_checkContainsRoot</a></h2>
<pre><code class="language-solidity">  function _checkContainsRoot(
    uint256 root
  ) internal
</code></pre>
<p>Raise an exception if the root is not present in the store.</p>
<h3 id="parameters-30"><a class="header" href="#parameters-30">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>root</code></td><td style="text-align: left">uint256</td><td style="text-align: left">The required root value</td></tr>
</tbody></table>
</div>
<hr />
<div style="break-before: page; page-break-before: always;"></div><h1 id="functions-4"><a class="header" href="#functions-4">Functions</a></h1>
<h2 id="batchverify"><a class="header" href="#batchverify">batchVerify</a></h2>
<pre><code class="language-solidity">  function batchVerify(
    struct IPlonkVerifier.VerifyingKey[] verifyingKeys,
    uint256[][] publicInputs,
    struct IPlonkVerifier.PlonkProof[] proofs,
    bytes[] extraTranscriptInitMsgs
  ) external returns (bool)
</code></pre>
<p>Batch verify multiple TurboPlonk proofs.</p>
<h3 id="parameters-31"><a class="header" href="#parameters-31">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>verifyingKeys</code></td><td style="text-align: left">struct IPlonkVerifier.VerifyingKey[]</td><td style="text-align: left">An array of verifying keys</td></tr>
<tr><td style="text-align: left"><code>publicInputs</code></td><td style="text-align: left">uint256[][]</td><td style="text-align: left">A two-dimensional array of public inputs.</td></tr>
<tr><td style="text-align: left"><code>proofs</code></td><td style="text-align: left">struct IPlonkVerifier.PlonkProof[]</td><td style="text-align: left">An array of Plonk proofs</td></tr>
<tr><td style="text-align: left"><code>extraTranscriptInitMsgs</code></td><td style="text-align: left">bytes[]</td><td style="text-align: left">An array of bytes from</td></tr>
<tr><td style="text-align: left">transcript initialization messages</td><td style="text-align: left"></td><td style="text-align: left"></td></tr>
</tbody></table>
</div>
<h3 id="return-values-5"><a class="header" href="#return-values-5">Return Values</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Returns</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left">⇒</td><td style="text-align: left">struct IPlonkVerifier.VerifyingKey[]</td><td style="text-align: left">A boolean that is true for successful verification, false otherwise</td></tr>
</tbody></table>
</div>
<hr />
<div style="break-before: page; page-break-before: always;"></div><h1 id="functions-5"><a class="header" href="#functions-5">Functions</a></h1>
<h2 id="batchverify-1"><a class="header" href="#batchverify-1">batchVerify</a></h2>
<pre><code class="language-solidity">  function batchVerify(
    struct IPlonkVerifier.VerifyingKey[] verifyingKeys,
    uint256[][] publicInputs,
    struct IPlonkVerifier.PlonkProof[] proofs,
    bytes[] extraTranscriptInitMsgs
  ) external returns (bool)
</code></pre>
<p>Batch verify multiple TurboPlonk proofs.</p>
<h3 id="parameters-32"><a class="header" href="#parameters-32">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>verifyingKeys</code></td><td style="text-align: left">struct IPlonkVerifier.VerifyingKey[]</td><td style="text-align: left">An array of verifier keys</td></tr>
<tr><td style="text-align: left"><code>publicInputs</code></td><td style="text-align: left">uint256[][]</td><td style="text-align: left">A two-dimensional array of public inputs.</td></tr>
<tr><td style="text-align: left"><code>proofs</code></td><td style="text-align: left">struct IPlonkVerifier.PlonkProof[]</td><td style="text-align: left">An array of Plonk proofs</td></tr>
<tr><td style="text-align: left"><code>extraTranscriptInitMsgs</code></td><td style="text-align: left">bytes[]</td><td style="text-align: left">An array of bytes from</td></tr>
<tr><td style="text-align: left">transcript initialization messages</td><td style="text-align: left"></td><td style="text-align: left"></td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_validateproof"><a class="header" href="#_validateproof">_validateProof</a></h2>
<pre><code class="language-solidity">  function _validateProof(
    struct IPlonkVerifier.PlonkProof proof
  ) internal
</code></pre>
<p>Validate all group points and scalar fields. Revert if
any are invalid.</p>
<h3 id="parameters-33"><a class="header" href="#parameters-33">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>proof</code></td><td style="text-align: left">struct IPlonkVerifier.PlonkProof</td><td style="text-align: left">A Plonk proof</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_preparepcsinfo"><a class="header" href="#_preparepcsinfo">_preparePcsInfo</a></h2>
<pre><code class="language-solidity">  function _preparePcsInfo(
  ) internal returns (struct PlonkVerifier.PcsInfo res)
</code></pre>
<hr />
<h2 id="_computechallenges"><a class="header" href="#_computechallenges">_computeChallenges</a></h2>
<pre><code class="language-solidity">  function _computeChallenges(
  ) internal returns (struct PlonkVerifier.Challenges res)
</code></pre>
<hr />
<h2 id="_computelinpolyconstantterm"><a class="header" href="#_computelinpolyconstantterm">_computeLinPolyConstantTerm</a></h2>
<pre><code class="language-solidity">  function _computeLinPolyConstantTerm(
  ) internal returns (uint256 res)
</code></pre>
<p>Compute the constant term of the linearization polynomial.</p>
<pre><code>r_plonk = PI - L1(x) * alpha^2 - alpha * \prod_i=1..m-1 (w_i + beta * sigma_i + gamma) * (w_m + gamma) * z(xw)
</code></pre>
<p>where m is the number of wire types.</p>
<hr />
<h2 id="_prepareopeningproof"><a class="header" href="#_prepareopeningproof">_prepareOpeningProof</a></h2>
<pre><code class="language-solidity">  function _prepareOpeningProof(
    struct IPlonkVerifier.VerifyingKey verifyingKey,
    struct PolynomialEval.EvalData evalData,
    struct IPlonkVerifier.PlonkProof proof,
    struct PlonkVerifier.Challenges chal,
    uint256[] commScalars,
    struct BN254.G1Point[] commBases
  ) internal returns (uint256 eval)
</code></pre>
<p>Compute components in [E]1 and [F]1 used for PolyComm opening verification
equivalent of JF's https://github.com/EspressoSystems/jellyfish/blob/main/plonk/src/proof_system/verifier.rs#L154-L170
caller allocates the memory fr commScalars and commBases
requires Arrays of size 30.</p>
<h3 id="parameters-34"><a class="header" href="#parameters-34">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>verifyingKey</code></td><td style="text-align: left">struct IPlonkVerifier.VerifyingKey</td><td style="text-align: left">A verifier key</td></tr>
<tr><td style="text-align: left"><code>evalData</code></td><td style="text-align: left">struct PolynomialEval.EvalData</td><td style="text-align: left">A polynomial evaluation</td></tr>
<tr><td style="text-align: left"><code>proof</code></td><td style="text-align: left">struct IPlonkVerifier.PlonkProof</td><td style="text-align: left">A Plonk proof</td></tr>
<tr><td style="text-align: left"><code>chal</code></td><td style="text-align: left">struct PlonkVerifier.Challenges</td><td style="text-align: left">A set of challenges</td></tr>
<tr><td style="text-align: left"><code>commScalars</code></td><td style="text-align: left">uint256[]</td><td style="text-align: left">Common scalars</td></tr>
<tr><td style="text-align: left"><code>commBases</code></td><td style="text-align: left">struct BN254.G1Point[]</td><td style="text-align: left">Common bases</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_preparepolycommitments"><a class="header" href="#_preparepolycommitments">_preparePolyCommitments</a></h2>
<pre><code class="language-solidity">  function _preparePolyCommitments(
  ) internal
</code></pre>
<p>Similar to <code>aggregate_poly_commitments()</code> in Jellyfish, but we are not aggregating multiple,
but rather preparing for <code>[F]1</code> from a single proof.
The caller allocates the memory fr commScalars and commBases.
Requires Arrays of size 30.</p>
<hr />
<h2 id="_prepareevaluations"><a class="header" href="#_prepareevaluations">_prepareEvaluations</a></h2>
<pre><code class="language-solidity">  function _prepareEvaluations(
    uint256 linPolyConstant,
    struct IPlonkVerifier.PlonkProof proof,
    uint256[] commScalars
  ) internal returns (uint256 eval)
</code></pre>
<p><code>aggregate_evaluations()</code> in Jellyfish, but since we are not aggregating multiple, but rather preparing <code>[E]1</code> from a single proof.
caller allocates the memory fr commScalars
requires Arrays of size 30.</p>
<h3 id="parameters-35"><a class="header" href="#parameters-35">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>linPolyConstant</code></td><td style="text-align: left">uint256</td><td style="text-align: left">A linear polynomial constant</td></tr>
<tr><td style="text-align: left"><code>proof</code></td><td style="text-align: left">struct IPlonkVerifier.PlonkProof</td><td style="text-align: left">A Plonk proof</td></tr>
<tr><td style="text-align: left"><code>commScalars</code></td><td style="text-align: left">uint256[]</td><td style="text-align: left">An array of common scalars</td></tr>
<tr><td style="text-align: left">The returned value is the scalar in <code>[E]1</code> described in Sec 8.4, step 11 of https://eprint.iacr.org/2019/953.pdf</td><td style="text-align: left"></td><td style="text-align: left"></td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_batchverifyopeningproofs"><a class="header" href="#_batchverifyopeningproofs">_batchVerifyOpeningProofs</a></h2>
<pre><code class="language-solidity">  function _batchVerifyOpeningProofs(
    struct PlonkVerifier.PcsInfo[] pcsInfos
  ) internal returns (bool)
</code></pre>
<p>Batchly verify multiple PCS opening proofs.
<code>open_key</code> has been assembled from BN254.P1(), BN254.P2() and contract variable _betaH
Returns true if the entire batch verifiies and false otherwise.</p>
<h3 id="parameters-36"><a class="header" href="#parameters-36">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>pcsInfos</code></td><td style="text-align: left">struct PlonkVerifier.PcsInfo[]</td><td style="text-align: left">An array of PcsInfo</td></tr>
</tbody></table>
</div>
<hr />
<h2 id="_linearizationscalarsandbases"><a class="header" href="#_linearizationscalarsandbases">_linearizationScalarsAndBases</a></h2>
<pre><code class="language-solidity">  function _linearizationScalarsAndBases(
    struct IPlonkVerifier.VerifyingKey verifyingKey,
    struct PlonkVerifier.Challenges challenge,
    struct PolynomialEval.EvalData evalData,
    struct IPlonkVerifier.PlonkProof proof,
    struct BN254.G1Point[] bases,
    uint256[] scalars
  ) internal
</code></pre>
<p>Compute the linearization of the scalars and bases.
The caller allocates the memory from commScalars and commBases.
Requires arrays of size 30.</p>
<h3 id="parameters-37"><a class="header" href="#parameters-37">Parameters</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">Name</th><th style="text-align: left">Type</th><th style="text-align: left">Description</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>verifyingKey</code></td><td style="text-align: left">struct IPlonkVerifier.VerifyingKey</td><td style="text-align: left">The verifying key</td></tr>
<tr><td style="text-align: left"><code>challenge</code></td><td style="text-align: left">struct PlonkVerifier.Challenges</td><td style="text-align: left">A set of challenges</td></tr>
<tr><td style="text-align: left"><code>evalData</code></td><td style="text-align: left">struct PolynomialEval.EvalData</td><td style="text-align: left">Polynomial evaluation data</td></tr>
<tr><td style="text-align: left"><code>proof</code></td><td style="text-align: left">struct IPlonkVerifier.PlonkProof</td><td style="text-align: left">A Plonk proof</td></tr>
<tr><td style="text-align: left"><code>bases</code></td><td style="text-align: left">struct BN254.G1Point[]</td><td style="text-align: left">An array of BN254 G1 points</td></tr>
<tr><td style="text-align: left"><code>scalars</code></td><td style="text-align: left">uint256[]</td><td style="text-align: left">An array of scalars</td></tr>
</tbody></table>
</div>
<hr />
<div style="break-before: page; page-break-before: always;"></div><h1 id="security"><a class="header" href="#security">Security</a></h1>
<div style="break-before: page; page-break-before: always;"></div><!--
 ~ Copyright (c) 2022 Espresso Systems (espressosys.com)
 ~ This file is part of the Configurable Asset Privacy for Ethereum (CAPE) library.
 ~
 ~ This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
 ~ This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 ~ You should have received a copy of the GNU General Public License along with this program. If not, see <https://www.gnu.org/licenses/>.
 -->
<h1 id="dos-attack-on-relayer-via-malicious-erc20-token-contract"><a class="header" href="#dos-attack-on-relayer-via-malicious-erc20-token-contract">DoS Attack on Relayer via malicious ERC20 token contract</a></h1>
<p>In this section we analyze a possible DoS attack on a relayer made possible by a malicious ERC20 Token.
The attack works as follows:</p>
<ul>
<li>Deploy an ERC20 CrashCoin with well-behaved <code>allow()</code> and <code>transferFrom</code>, but <code>transfer</code> reverts immediately.</li>
<li>Wrap 1 <code>CrashCoin</code> in CAPE.</li>
<li>Submit a <code>CrashCoin</code> burn/unwrap transaction to a relayer.</li>
<li>The relayer includes it in the block.</li>
<li>The block gets &quot;rejected&quot; when it calls <code>CrashCoin.transfer</code>.</li>
</ul>
<p>Possible mitigations:</p>
<ol>
<li>The relayer could try to run the Ethereum transaction first. This would probably catch most of these cases. The user could however use a token that calls to a proxy and frontrun the relayer's TX to change the token to become malicious before the real TX goes through.</li>
<li>Only whitelisted tokens can be sponsored. </li>
<li>Instead of withdrawing during the block submission we just do the bookkeeping and mark funds as &quot;available for withdrawal to address&quot;. The user later needs to run the withdraw transaction that moves the funds. </li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
