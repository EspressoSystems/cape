#!/usr/bin/env bash
set -euo pipefail

NUM_KEYS=2
DATA_DIR="$(mktemp -d -t "cap-ethereum-data-XXXXXXXX")"

trap "exit" INT TERM
trap cleanup EXIT
cleanup(){
    echo "Cleaning up geth node"
    if [ -d $DATA_DIR ]; then
        echo "Removing geth data dir $DATA_DIR"
        rm -r $DATA_DIR
    fi
    # kill the geth child process
    kill $(jobs -p) 2> /dev/null
}

echo "Using keystore dir $DATA_DIR"
mkdir -p "$DATA_DIR"

ADDRESS_LIST=$(hdwallet-derive --mnemonic "$TEST_MNEMONIC" --num-keys $NUM_KEYS --property address | tr '\n' ',')
make-genesis-block --addresses $ADDRESS_LIST > $DATA_DIR/genesis.json

# Import private keys generated by hdwallet-derive script into geth
while IFS= read -r LINE || [[ -n "$LINE" ]]; do
    echo "Importing private key $LINE"
    geth --verbosity 0 --datadir "$DATA_DIR" \
        account import --password <(echo "") <(echo $LINE)
done < <(hdwallet-derive --mnemonic "$TEST_MNEMONIC" --num-keys $NUM_KEYS --property private_key)

echo "Initializing geth with genesis file"
geth --dev init --datadir $DATA_DIR $DATA_DIR/genesis.json


echo "Starting geth node ..."
geth --http --dev \
     --mine --maxpeers 0 --nodiscover \
     --miner.gaslimit 25000000 \
     --allow-insecure-unlock \
     --password <(echo "") \
     --datadir $DATA_DIR --unlock $ADDRESS_LIST \
     "$@"
