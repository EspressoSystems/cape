#!/usr/bin/env bash
# Copyright (c) 2022 Espresso Systems (espressosys.com)
# This file is part of the Configurable Asset Privacy for Ethereum (CAPE) library.
#
# This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
# This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
# You should have received a copy of the GNU General Public License along with this program. If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

RED='\033[0;31m'
GETH_PORT=8545

if nc -z localhost $GETH_PORT 2>&1; then
    echo -e "${RED}GETH_PORT $GETH_PORT already in use! Aborting"
    exit 1
fi

# Create a faucet manager wallet and export variables printed to stdout
export CAPE_FAUCET_MANAGER_MNEMONIC="$TEST_MNEMONIC"
source <(cargo run --release --bin faucet-wallet-test-setup)

#
# Set up a geth chain and deploy the contracts. Then shut it down.
#
GETH_DATA_DIR="scratch/geth-data-dir"
echo "Using keystore dir $GETH_DATA_DIR"
mkdir -p "$GETH_DATA_DIR"

NUM_KEYS=2
ADDRESS_LIST=$(hdwallet-derive --mnemonic "$TEST_MNEMONIC" --num-keys $NUM_KEYS --property address | tr '\n' ',')
# Default to 1 second block time
PERIOD=${GETH_PERIOD:-1}
make-genesis-block --addresses $ADDRESS_LIST --period $PERIOD > $GETH_DATA_DIR/genesis.json

# Import private keys generated by hdwallet-derive script into geth
while IFS= read -r LINE || [[ -n "$LINE" ]]; do
    echo "Importing private key $LINE"
    geth --verbosity 0 --datadir "$GETH_DATA_DIR" \
        account import --password <(echo "") <(echo $LINE)
done < <(hdwallet-derive --mnemonic "$TEST_MNEMONIC" --num-keys $NUM_KEYS --property private_key)

echo "Initializing geth with genesis file"
geth --dev init --datadir $GETH_DATA_DIR $GETH_DATA_DIR/genesis.json

# docker compose will issue lots of warnings if some variables are not set, even
# if these aren't needed to start this particular service.
echo "Starting geth node ..."
geth --http --dev --verbosity 1 \
     --mine --maxpeers 0 --nodiscover \
     --miner.gaslimit 25000000 \
     --allow-insecure-unlock \
     --password <(echo "") \
     --datadir $GETH_DATA_DIR --unlock $ADDRESS_LIST &
geth_pid=$!

# Deploy contracts (this requires the address/key exported with the
# faucet-wallet-test-setup binary)
hardhat deploy --reset

# Stop the geth node
echo "Sending TERM signal to geth: PID $geth_pid"
kill -TERM $geth_pid

echo "Geth DATA_DIR at $GETH_DATA_DIR"
